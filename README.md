# –î–∏–ø–ª–æ–º–Ω—ã–π –ø—Ä–∞–∫—Ç–∏–∫—É–º –≤ Yandex.Cloud

> **DevOps –ø—Ä–æ–µ–∫—Ç –ø–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤ Yandex Cloud**

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–¶–µ–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞](#—Ü–µ–ª–∏-–ø—Ä–æ–µ–∫—Ç–∞)
- [–≠—Ç–∞–ø—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è](#—ç—Ç–∞–ø—ã-–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)
  - [1. –°–æ–∑–¥–∞–Ω–∏–µ –æ–±–ª–∞—á–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã](#1-—Å–æ–∑–¥–∞–Ω–∏–µ-–æ–±–ª–∞—á–Ω–æ–π-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã)
  - [2. –°–æ–∑–¥–∞–Ω–∏–µ Kubernetes –∫–ª–∞—Å—Ç–µ—Ä–∞](#2-—Å–æ–∑–¥–∞–Ω–∏–µ-kubernetes-–∫–ª–∞—Å—Ç–µ—Ä–∞)
  - [3. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è](#3-—Å–æ–∑–¥–∞–Ω–∏–µ-—Ç–µ—Å—Ç–æ–≤–æ–≥–æ-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
  - [4. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –¥–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è](#4-–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞-—Å–∏—Å—Ç–µ–º—ã-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞-–∏-–¥–µ–ø–ª–æ–π-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
  - [5. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ CI/CD](#5-—É—Å—Ç–∞–Ω–æ–≤–∫–∞-–∏-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-cicd)
- [–ò—Ç–æ–≥–∏ –ø—Ä–æ–µ–∫—Ç–∞](#–∏—Ç–æ–≥–∏-–ø—Ä–æ–µ–∫—Ç–∞)

---

## üéØ –¶–µ–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞

1. **–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –æ–±–ª–∞—á–Ω—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É** –Ω–∞ –±–∞–∑–µ Yandex.Cloud
2. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –∏ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞—Ç—å Kubernetes –∫–ª–∞—Å—Ç–µ—Ä** —Å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π
3. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞** (Prometheus + Grafana)
4. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é —Å–±–æ—Ä–∫–∏** —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
5. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å CI** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–±–æ—Ä–∫–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
6. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å CD** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

---

## üöÄ –≠—Ç–∞–ø—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –æ–±–ª–∞—á–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

<details>
<summary><strong>üìÅ –ü—Ä–µ–¥–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ Backend</strong></summary>

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Terraform Backend

–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º Backend –ø—Ä–∏ –ø–æ–º–æ—â–∏ **Terraform** –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.

**–°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–µ —Ä–µ—Å—É—Ä—Å—ã:**
- S3 —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è Terraform state
- DNS –∑–æ–Ω—É –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç Let's Encrypt

**–ú–∞–Ω–∏—Ñ–µ—Å—Ç—ã:**
- [DNS –∑–æ–Ω–∞ –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç](./bucket/dns.tf)
- [S3 —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è state](./bucket/s3.tf)

**–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞:**
```bash
# –ü–æ–ª—É—á–∞–µ–º –∫–ª—é—á–∏ –¥–æ—Å—Ç—É–ø–∞
terraform output -raw terraform_backend_secret_key

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å backend –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
terraform init --backend-config="access_key=******" --backend-config="secret_key=******"
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
![S3 State Storage](./images/01.png)

</details>

<details>
<summary><strong>üèóÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã</strong></summary>

#### –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ CI/CD

–°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ **GitHub Actions**.

**–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π Terraform:** [terraform-dapp](https://github.com/barmaq/terraform-dapp)

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

**VPC —Å –ø–æ–¥—Å–µ—Ç—è–º–∏ –≤ —Ä–∞–∑–Ω—ã—Ö –∑–æ–Ω–∞—Ö –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:**
- [–û—Å–Ω–æ–≤–Ω–æ–π –º–∞–Ω–∏—Ñ–µ—Å—Ç VPC](https://github.com/barmaq/terraform-dapp/blob/main/main.tf)

![VPC Configuration](./images/yc-vpc.png)

#### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã CI/CD

> **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü–æ—Å–∫–æ–ª—å–∫—É –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ Terraform, –≤ –ª–æ–≥–∞—Ö –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤.

**–õ–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [–ü–æ–ª–Ω—ã–π –ª–æ–≥ workflow](./terraform_cicd_logs/)
- [–õ–æ–≥ Terraform Apply](./terraform_cicd_logs/9_Terraform%20Apply.txt)

**–°–∫—Ä–∏–Ω—à–æ—Ç—ã –ø—Ä–æ—Ü–µ—Å—Å–∞:**
- [Terraform CI/CD - 1](./images/terraform-cicd-01.png)
- [Terraform CI/CD - 2](./images/terraform-cicd-02.png)
- [Terraform CI/CD - 3](./images/terraform-cicd-03.png)

</details>

---

### 2. –°–æ–∑–¥–∞–Ω–∏–µ Kubernetes –∫–ª–∞—Å—Ç–µ—Ä–∞

<details>
<summary><strong>‚öôÔ∏è –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞</strong></summary>

> **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—É—é —É—Å—Ç–∞–Ω–æ–≤–∫—É –∫–ª–∞—Å—Ç–µ—Ä–∞ –≤–º–µ—Å—Ç–æ –æ–±–ª–∞—á–Ω–æ–≥–æ —Ä–µ—Å—É—Ä—Å–∞ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è.

#### –≠—Ç–∞–ø—ã —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞

**1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã**

–°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–µ—Ä—ã –¥–ª—è –±—É–¥—É—â–µ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞:

**Control Plane —É–∑–ª—ã:**
- [–ú–∞–Ω–∏—Ñ–µ—Å—Ç Control Plane](https://github.com/barmaq/terraform-dapp/blob/main/k8s-cp.tf)
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `kube-k8s_cp_count` –≤ variables.tf
- **–í–∞–∂–Ω–æ:** –ü—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ —Å—Ç–∞–≤–∏—Ç—å –Ω–µ –º–µ–Ω—å—à–µ 3 —É–∑–ª–æ–≤

**Worker —É–∑–ª—ã:**
- [–ú–∞–Ω–∏—Ñ–µ—Å—Ç Worker Nodes](https://github.com/barmaq/terraform-dapp/blob/main/k8s-nodes.tf)
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `kube-k8s_nodes_count` –≤ variables.tf

**–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∑–æ–Ω–∞–º:**
- –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ —Ç—Ä–µ—Ö –∑–æ–Ω–∞—Ö –ø–æ –æ—á–µ—Ä–µ–¥–∏
- –ü–µ—Ä–≤–∞—è ‚Üí –∑–æ–Ω–∞ A, –≤—Ç–æ—Ä–∞—è ‚Üí –∑–æ–Ω–∞ B, —Ç—Ä–µ—Ç—å—è ‚Üí –∑–æ–Ω–∞ D

![Virtual Machines](./images/yc-vm.png)

**2. –°–æ–∑–¥–∞–Ω–∏–µ Ansible Inventory**

–§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –Ω–∞ –æ—Å–Ω–æ–≤–µ —à–∞–±–ª–æ–Ω–∞:

<details>
<summary>–ö–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è</summary>

```hcl
resource "local_file" "inventory" {
  content = templatefile("${path.module}/templates/inventory.tpl", {
    control_plane_internal_ips = yandex_compute_instance.kube-cp[*].network_interface[0].ip_address
    worker_node_internal_ips = yandex_compute_instance.kube-nodes[*].network_interface[0].ip_address
  })
  filename = "${path.module}/inventory.yml"
}
```

</details>

**–®–∞–±–ª–æ–Ω—ã:**
- [–®–∞–±–ª–æ–Ω inventory](https://github.com/barmaq/terraform-dapp/blob/main/templates/inventory.tpl)

**3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Ansible**

- –ó–∞–ø—É—Å–∫ —Å –ø–µ—Ä–≤–æ–π –º–∞—à–∏–Ω—ã Control Plane (–∏–Ω–¥–µ–∫—Å [0])
- –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ SSH –∫–ª—é—á–µ–π
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ

**–ú–∞–Ω–∏—Ñ–µ—Å—Ç:** [k8s-cluster.tf](https://github.com/barmaq/terraform-dapp/blob/main/k8s-cluster.tf)

**4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Kubernetes**

- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Kubespray –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞
- **–í—Ä–µ–º—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏:** 10-20 –º–∏–Ω—É—Ç
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
- –í—ã–≤–æ–¥ kubeconfig –≤ Terraform Outputs

**–ü—Ä–æ—Å–º–æ—Ç—Ä kubeconfig:**
```bash
terraform output -raw kubeconfig
```

**5. –†–µ–∑—É–ª—å—Ç–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏**

–ö–ª–∞—Å—Ç–µ—Ä —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –°–ø–∏—Å–æ–∫ –ø–æ–¥–æ–≤ –∏ –Ω–æ–¥
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å

![Kubernetes Cluster](./images/k8s.png)
![Ansible Inventory](./images/inventory.png)

</details>

---

### 3. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

<details>
<summary><strong>üì± –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</strong></summary>

#### –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–Ω–æ –ø—Ä–æ—Å—Ç–æ–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –º–∏–Ω–∏-–∏–≥—Ä–æ–π –∏ nginx —Å–µ—Ä–≤–µ—Ä–æ–º.

**–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:** [barmaq-dapp](https://github.com/barmaq/barmaq-dapp)
**Dockerfile:** [Dockerfile](https://github.com/barmaq/barmaq-dapp/blob/11d15827731fcdbef74963609c1e0d77a6c72a77/Dockerfile)

#### Docker –æ–±—Ä–∞–∑

–û–±—Ä–∞–∑ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ DockerHub:
- [Docker Image](https://hub.docker.com/repository/docker/barmaq/barmaq-dapp/general)

![Docker Image](./images/04.png)

</details>

---

### 4. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –¥–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

<details>
<summary><strong>üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –¥–µ–ø–ª–æ–π</strong></summary>

#### –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ Kubernetes –∫–ª–∞—Å—Ç–µ—Ä–µ

**1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**

- **Helm —á–∞—Ä—Ç:** kube-prometheus
- **–ú–∞–Ω–∏—Ñ–µ—Å—Ç:** [grafana.tf](https://github.com/barmaq/terraform-dapp/blob/main/graphana.tf)
- **–ù–∞—Å—Ç—Ä–æ–π–∫–∞:** –ü–∞—Ä–æ–ª—å Grafana —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `grafana_admin_password`

**2. –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–æ—Å—Ç—É–ø–∞**

- NodePort —Å–µ—Ä–≤–∏—Å –¥–ª—è Grafana
- –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ Terraform Outputs

**3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**

–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ Kubernetes –∫–ª–∞—Å—Ç–µ—Ä–µ:

**–®–∞–±–ª–æ–Ω—ã Kubernetes –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤:**
- [Deployment](https://github.com/barmaq/terraform-dapp/blob/main/k8s-templates/deployment.yaml.tpl)
- [Service](https://github.com/barmaq/terraform-dapp/blob/main/k8s-templates/service.yaml.tpl)

**–ú–∞–Ω–∏—Ñ–µ—Å—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏:** [app.tf](https://github.com/barmaq/terraform-dapp/blob/main/app.tf)

**4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ç–µ–≤–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞**

- DNS A –∑–∞–ø–∏—Å—å
- Load Balancer –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–ú–∞–Ω–∏—Ñ–µ—Å—Ç:** [load-balancer.tf](https://github.com/barmaq/terraform-dapp/blob/main/load-balancer.tf)

#### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

**–î–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é:**
- **URL:** [app.barmaq.ru](https://app.barmaq.ru)

**–î–æ—Å—Ç—É–ø –∫ Grafana:**
- **URL:** [–≤–µ–± –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Grafana](http://51.250.64.79:30000/)

<details>
<summary>–£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞ –≤ Grafana</summary>

| –ü–æ–ª–µ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|------|----------|
| **–õ–æ–≥–∏–Ω** | `admin` |
| **–ü–∞—Ä–æ–ª—å** | `ipt6CXqd0r` |

</details>

#### –î–∞—à–±–æ—Ä–¥—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—à–±–æ—Ä–¥—ã:**
- [–î–∞—à–±–æ—Ä–¥ –ø–æ–¥–æ–≤](./images/mon-pods.png)
- [–î–∞—à–±–æ—Ä–¥ —Å–µ—Ç–∏](./images/mon-nw.png)
- [–î–∞—à–±–æ—Ä–¥ –∫–ª–∞—Å—Ç–µ—Ä–∞](./images/mon-kubelet.png)
- [–î–∞—à–±–æ—Ä–¥ –Ω–µ–π–º—Å–ø–µ–π—Å–æ–≤](./images/mon-n.png)

</details>

---

### 5. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ CI/CD

<details>
<summary><strong>üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤</strong></summary>

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitHub Actions

**–¶–µ–ª—å:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞ –∏ –¥–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–¥–∞.

#### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ GitHub:**
- –ö–ª—é—á –æ—Ç DockerHub
- kubeconfig –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–ª–∞—Å—Ç–µ—Ä—É

![Environment Variables](./images/cicd-01.png)

#### Workflow –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**–§–∞–π–ª:** [ci_cd.yaml](https://github.com/barmaq/barmaq-dapp/blob/b577f3d28db46af2f4580c52cdc3d239915d57c7/.github/workflows/ci_cd.yaml)

**–≠—Ç–∞–ø—ã pipeline (–ø—Ä–∏ push –≤ main):**
1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–Ω—Ç–µ—Ä–∞–º–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
2. **–°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ DockerHub**
3. **–î–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ Kubernetes**

#### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞–±–æ—Ç—ã CI/CD

**–í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è v0.0.13:**
![App v0.0.13](./images/app.png)

**Git commit:**
![Git Commit](./images/git_commit.png)

**–†–µ–∑—É–ª—å—Ç–∞—Ç pipeline:**
![Pipeline Result](./images/cicd-02.png)

**–õ–æ–≥ rollout –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**
![Rollout Log](./images/cicd-03.png)

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ –≤–µ—Ä—Å–∏–∏ v0.0.14:**
![App v0.0.14](./images/app2.png)

</details>

---

## üìã –ò—Ç–æ–≥–∏ –ø—Ä–æ–µ–∫—Ç–∞

### –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è

–í—Å–µ —Ä–µ—Å—É—Ä—Å—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ Terraform. –†—É—á–Ω–æ–µ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ - —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ `kubeconfig` –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ —Ñ–∞–π–ª `secret.auto.tfvars` –∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `.gitignore`.

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞

| ‚Ññ | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ | –°—Å—ã–ª–∫–∞ |
|---|-----------|----------|--------|
| **1** | Backend | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã Terraform. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ DNS, —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç | [backend](https://github.com/barmaq/terraform-dapp/tree/main/bucket) |
| **2** | –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ | Terraform –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞, Kubernetes –∫–ª–∞—Å—Ç–µ—Ä, ALB –±–∞–ª–∞–Ω—Å–µ—Ä, —Ä–∞–∑–≤–µ—Ä—Ç–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è | [terraform-dapp](https://github.com/barmaq/terraform-dapp) |
| **3** | –õ–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è | –í—ã–≤–æ–¥ terraform apply (–±–æ–ª—å—à–æ–π —Ñ–∞–π–ª –∏–∑-–∑–∞ –ª–æ–≥–æ–≤ Kubespray) | [–ª–æ–≥ terraform apply](./terraform_cicd_logs/9_Terraform%20Apply.txt) |
| **4** | –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ | –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å Dockerfile –∏ Docker –æ–±—Ä–∞–∑ | [—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π](https://github.com/barmaq/barmaq-dapp) / [Docker image](https://hub.docker.com/repository/docker/barmaq/barmaq-dapp/general) |
| **5** | –î–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å–∞–º | –¢–µ—Å—Ç–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –≤–µ–± –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Grafana | [app.barmaq.ru](https://app.barmaq.ru) |

### –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Grafana

<details>
<summary>–î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞</summary>

| –ü–æ–ª–µ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|------|----------|
| **–õ–æ–≥–∏–Ω** | `admin` |
| **–ü–∞—Ä–æ–ª—å** | `ipt6CXqd0r` |

</details>

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ Terraform

**Outputs:**
![Terraform Outputs](./images/terraform-apply.png)

### –†–µ—Å—É—Ä—Å—ã –≤ Yandex Cloud

**–û–±–∑–æ—Ä —Ä–µ—Å—É—Ä—Å–æ–≤:**
- [–û–±—â–∏–µ —Ä–µ—Å—É—Ä—Å—ã](./images/yc-all.png)
- [VPC](./images/yc-vpc.png)
- [–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã](./images/yc-vm.png)
- [Load Balancer](./images/yc-alb.png)
- [DNS –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç](./images/dns-dns.png) / [–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç](./images/dns-cert.png)

---

## üë®‚Äçüíª –ê–≤—Ç–æ—Ä

**–®—É–º—Å–∫–∏–π –í–∏–∫—Ç–æ—Ä / barmaq**

–ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω –¥–ª—è –¥–∏–ø–ª–æ–º–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.


